{% extends "base.html" %}

{% block title %}Dashboard - Brasileir√£o 2026{% endblock %}

{% block content %}
<h1>Dashboard</h1>

<!-- Sele√ß√£o de Competi√ß√£o -->
<div style="background: var(--cinza); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
    <label style="display: block; margin-bottom: 0.5rem; color: var(--texto-fraco); font-size: 0.9rem;">COMPETI√á√ÉO</label>
    <select onchange="window.location.href='/dashboard?competicao_id=' + this.value" 
        style="width: 100%; padding: 0.8rem; background: var(--cinza-medio); border: 1px solid var(--cinza-medio); 
               border-radius: 6px; color: var(--texto); font-size: 1rem;">
        {% for comp in competicoes %}
        <option value="{{ comp.id }}" {% if competicao_selecionada == comp.id %}selected{% endif %}>
            {{ comp.nome }}
        </option>
        {% endfor %}
    </select>
</div>

<!-- Tabela Geral -->
<div style="background: var(--cinza); border-radius: 8px; overflow: hidden; margin-bottom: 2rem;">
    <div class="tabela-responsiva">
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="border-bottom: 2px solid var(--verde);">
                <th style="text-align: left; padding: 0.7rem 1rem; color: var(--texto-fraco);">TIME</th>
                <th style="text-align: center; padding: 0.7rem 1rem; color: var(--texto-fraco); cursor: pointer;" onclick="window.location.href='/dashboard?ordenar=pontos_reais&competicao_id={{ competicao_selecionada }}'">
                    PTS REAIS {% if ordenar_por == 'pontos_reais' %}‚ñº{% endif %}
                </th>
                <th style="text-align: center; padding: 0.7rem 1rem; color: var(--amarelo); cursor: pointer;" onclick="window.location.href='/dashboard?ordenar=titulo&competicao_id={{ competicao_selecionada }}'">
                    üèÜ T√çTULO {% if ordenar_por == 'titulo' %}‚ñº{% endif %}
                </th>
                <th  style="text-align: center; padding: 0.7rem 1rem; color: var(--verde); cursor: pointer;" onclick="window.location.href='/dashboard?ordenar=libertadores&competicao_id={{ competicao_selecionada }}'">
                    üåé LIBERTADORES {% if ordenar_por == 'libertadores' %}‚ñº{% endif %}
                </th>
                <th  style="text-align: center; padding: 0.7rem 1rem; color: #e74c3c; cursor: pointer;" onclick="window.location.href='/dashboard?ordenar=rebaixamento&competicao_id={{ competicao_selecionada }}'">
                    ‚¨áÔ∏è REBAIXAMENTO {% if ordenar_por == 'rebaixamento' %}‚ñº{% endif %}
                </th>
            </tr>
        </thead>
        <tbody>
            {% for item in tabela %}
            <tr style="border-bottom: 1px solid var(--cinza-medio); cursor: pointer; transition: background 0.2s;" 
                onmouseover="this.style.background='var(--cinza-medio)'" 
                onmouseout="this.style.background='transparent'"
                onclick="window.location.href='/dashboard?time_id={{ item.time.id }}&competicao_id={{ competicao_selecionada }}'">
                <td style="padding: 0.8rem 1rem;">{{ item.time.nome }}</td>
                <td style="padding: 0.8rem 1rem; text-align: center; font-weight: 600;">{{ item.pontos_reais }}</td>
                
                {% for tipo in ['titulo', 'libertadores', 'rebaixamento'] %}
                <td  style="padding: 0.8rem 1rem; text-align: center;">
                    <div style="display: inline-block; padding: 0.2rem 0.6rem; border-radius: 4px; font-weight: 600; font-size: 0.9rem;
                                background: {% if item.cenarios[tipo].pct >= 100 %}var(--verde){% elif item.cenarios[tipo].pct >= 80 %}var(--amarelo){% else %}#e74c3c{% endif %}; color: #000;">
                        {{ item.cenarios[tipo].pct }}%
                    </div>
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
        </table>
    </div>
</div>

<!-- Detalhe por Time -->
{% if time_selecionado %}
<div style="margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>{{ time_selecionado.nome }}</h2>
        <a href="/dashboard?competicao_id={{ competicao_selecionada }}" style="color: var(--texto-fraco); text-decoration: none; font-size: 0.9rem;">‚Üê Voltar</a>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
        {% for tipo, nome, cor in [('titulo', 'T√≠tulo', 'var(--amarelo)'), ('libertadores', 'Libertadores', 'var(--verde)'), ('rebaixamento', 'Rebaixamento', '#e74c3c')] %}
        <div style="background: var(--cinza); padding: 1.5rem; border-radius: 8px; border-left: 3px solid {{ cor }};">
            <div style="color: var(--texto-fraco); font-size: 0.85rem; margin-bottom: 0.5rem;">{{ nome }}</div>
            <div style="font-size: 2rem; font-weight: 600; margin-bottom: 0.5rem;">{{ detalhe.cenarios[tipo].pct }}%</div>
            <div style="font-size: 0.9rem;">
                <span style="color: var(--texto-fraco);">Real:</span> {{ detalhe.cenarios[tipo].real }} pts
                <span style="margin: 0 0.5rem;">‚Ä¢</span>
                <span style="color: var(--texto-fraco);">Proj:</span> {{ detalhe.cenarios[tipo].projetado_ate_agora }} pts
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.85rem; color: {% if detalhe.cenarios[tipo].diff >= 0 %}var(--verde){% else %}#e74c3c{% endif %};">
                {% if detalhe.cenarios[tipo].diff >= 0 %}+{% endif %}{{ detalhe.cenarios[tipo].diff }} pts
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Gr√°fico de Evolu√ß√£o -->
    <div style="background: var(--cinza); padding: 1.5rem; border-radius: 8px;">
        <h3 style="margin-bottom: 1rem;">Evolu√ß√£o</h3>
        <canvas id="chart-evolucao"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('chart-evolucao');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: [{% for ev in detalhe.evolucao %}'Rodada {{ ev.rodada }}'{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [
            {
                label: 'Real',
                data: [{% for ev in detalhe.evolucao %}{{ ev.real }}{% if not loop.last %},{% endif %}{% endfor %}],
                borderColor: '#fff',
                backgroundColor: 'rgba(255,255,255,0.1)',
                tension: 0.4
            },
            {
                label: 'T√≠tulo',
                data: [{% for ev in detalhe.evolucao %}{{ ev.titulo }}{% if not loop.last %},{% endif %}{% endfor %}],
                borderColor: '#ffd700',
                borderDash: [5, 5],
                tension: 0.4
            },
            {
                label: 'Libertadores',
                data: [{% for ev in detalhe.evolucao %}{{ ev.libertadores }}{% if not loop.last %},{% endif %}{% endfor %}],
                borderColor: '#00a651',
                borderDash: [5, 5],
                tension: 0.4
            },
            {
                label: 'Rebaixamento',
                data: [{% for ev in detalhe.evolucao %}{{ ev.rebaixamento }}{% if not loop.last %},{% endif %}{% endfor %}],
                borderColor: '#e74c3c',
                borderDash: [5, 5],
                tension: 0.4
            }
        ]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { labels: { color: '#fff' } }
        },
        scales: {
            y: { ticks: { color: '#888' }, grid: { color: '#333' } },
            x: { ticks: { color: '#888' }, grid: { color: '#333' } }
        }
    }
});
</script>
{% endif %}
<style>
@media (max-width: 768px) {
    h1 {
        font-size: 1.5rem !important;
    }
    
    /* Container com scroll horizontal */
    .tabela-responsiva {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -1rem; /* Expande at√© as bordas */
        padding: 0 1rem;
    }
    
    /* Tabela com largura m√≠nima */
    .tabela-responsiva table {
        min-width: 700px; /* Garante que n√£o esmaga */
        font-size: 0.8rem;
    }
    
    /* Compacta paddings */
    .tabela-responsiva th {
        padding: 0.5rem 0.3rem !important;
        font-size: 0.7rem;
    }
    
    .tabela-responsiva td {
        padding: 0.6rem 0.3rem !important;
    }
    
    /* Compacta textos */
    .tabela-responsiva th span {
        font-size: 0.6rem !important;
    }
    
    /* Reduz tamanho das medalhas/percentuais */
    .tabela-responsiva .badge-percentual {
        font-size: 0.7rem !important;
        padding: 0.2rem 0.4rem !important;
    }
    
    /* Indicador de scroll */
    .tabela-responsiva::after {
        content: '‚Üê Arraste para ver mais ‚Üí';
        display: block;
        text-align: center;
        padding: 0.5rem;
        font-size: 0.75rem;
        color: var(--texto-fraco);
    }
}
</style>
{% endblock %}
