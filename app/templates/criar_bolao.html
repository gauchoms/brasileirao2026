{% extends "base.html" %}

{% block title %}Criar Bol√£o{% endblock %}

{% block content %}
<div style="max-width: 600px; margin: 2rem auto;">
    <h1 style="margin-bottom: 2rem;">Criar Novo Bol√£o</h1>

    {% if erro %}
    <div style="background: #e74c3c; color: white; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
        {{ erro }}
    </div>
    {% endif %}

    <form method="POST" id="form-criar-bolao" style="background: var(--cinza); padding: 2rem; border-radius: 8px;">
        
        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--texto-fraco); font-size: 0.9rem;">NOME DO BOL√ÉO</label>
            <input type="text" name="nome" required placeholder="Ex: Bol√£o da Copa 2026"
                style="width: 100%; padding: 0.8rem; background: var(--cinza-medio); border: 1px solid var(--cinza-medio); 
                       border-radius: 6px; color: var(--texto); font-size: 1rem;">
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--texto-fraco); font-size: 0.9rem;">TIPO DE BOL√ÉO</label>
            <select name="tipo_bolao" id="tipo-bolao" onchange="mostrarCampos()" required
                style="width: 100%; padding: 0.8rem; background: var(--cinza-medio); border: 1px solid var(--cinza-medio); 
                       border-radius: 6px; color: var(--texto); font-size: 1rem;">
                <option value="campeonato_completo">Campeonato Completo</option>
                <option value="time_campeonato">Time em um Campeonato</option>
                <option value="time_ano_completo">Time em Todas as Competi√ß√µes do Ano</option>
            </select>
        </div>

        <div id="campos-campeonato-completo" style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--texto-fraco); font-size: 0.9rem;">COMPETI√á√ÉO</label>
            <select name="competicao_id" id="select-competicao"
                style="width: 100%; padding: 0.8rem; background: var(--cinza-medio); border: 1px solid var(--cinza-medio); 
                       border-radius: 6px; color: var(--texto); font-size: 1rem;">
                <option value="">Selecione uma competi√ß√£o</option>
                {% for comp in competicoes %}
                <option value="{{ comp.id }}">{{ comp.nome }}</option>
                {% endfor %}
            </select>
        </div>

        <div id="campos-time-campeonato" style="display: none;">
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--texto-fraco); font-size: 0.9rem;">COMPETI√á√ÉO</label>
                <select name="competicao_id_time" id="select-competicao-time" onchange="carregarTimesCampeonato()"
                    style="width: 100%; padding: 0.8rem; background: var(--cinza-medio); border: 1px solid var(--cinza-medio); 
                           border-radius: 6px; color: var(--texto); font-size: 1rem;">
                    <option value="">Selecione uma competi√ß√£o</option>
                    {% for comp in competicoes %}
                    <option value="{{ comp.id }}">{{ comp.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--texto-fraco); font-size: 0.9rem;">TIME</label>
                <select name="time_id_campeonato" id="select-time-campeonato"
                    style="width: 100%; padding: 0.8rem; background: var(--cinza-medio); border: 1px solid var(--cinza-medio); 
                           border-radius: 6px; color: var(--texto); font-size: 1rem;">
                    <option value="">Escolha a competi√ß√£o primeiro</option>
                </select>
            </div>
        </div>

        <div id="campos-time-ano" style="display: none;">
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--texto-fraco); font-size: 0.9rem;">TIME</label>
                <select name="time_id_ano" id="select-time-ano"
                    style="width: 100%; padding: 0.8rem; background: var(--cinza-medio); border: 1px solid var(--cinza-medio); 
                           border-radius: 6px; color: var(--texto); font-size: 1rem;">
                    <option value="">Selecione um time</option>
                    {% for time in times %}
                    <option value="{{ time.id }}">{{ time.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--texto-fraco); font-size: 0.9rem;">ANO</label>
                <select name="ano"
                    style="width: 100%; padding: 0.8rem; background: var(--cinza-medio); border: 1px solid var(--cinza-medio); 
                           border-radius: 6px; color: var(--texto); font-size: 1rem;">
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026" selected>2026</option>
                    <option value="2027">2027</option>
                </select>
            </div>
        </div>

       <!-- Configura√ß√£o de Pontua√ß√£o -->
        <div style="background: var(--cinza-medio); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <h3 style="margin-bottom: 1rem; color: var(--amarelo);">‚öôÔ∏è Sistema de Pontua√ß√£o</h3>
            
            <p style="color: var(--texto-fraco); margin-bottom: 1.5rem; font-size: 0.9rem;">
                Configure quantos pontos cada acerto vale. A pontua√ß√£o √© <strong>acumulativa</strong> - quanto mais acertos, mais pontos!
            </p>
            
            <!-- Pontos Base -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.3rem; color: var(--texto-fraco); font-size: 0.85rem;">
                        ‚úÖ Acertar Resultado (vit√≥ria/empate)
                    </label>
                    <input type="number" name="pts_resultado" id="pts-resultado" value="5" min="0" required
                        onchange="atualizarSimulador()"
                        style="width: 100%; padding: 0.6rem; background: var(--cinza); border: 1px solid var(--cinza); 
                               border-radius: 6px; color: var(--texto);">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 0.3rem; color: var(--texto-fraco); font-size: 0.85rem;">
                        üéØ + Acertar Gols do Vencedor
                    </label>
                    <input type="number" name="pts_gols_vencedor" id="pts-gols-vencedor" value="3" min="0" required
                        onchange="atualizarSimulador()"
                        style="width: 100%; padding: 0.6rem; background: var(--cinza); border: 1px solid var(--cinza); 
                               border-radius: 6px; color: var(--texto);">
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.3rem; color: var(--texto-fraco); font-size: 0.85rem;">
                        ‚ùå + Acertar Gols do Perdedor
                    </label>
                    <input type="number" name="pts_gols_perdedor" id="pts-gols-perdedor" value="2" min="0" required
                        onchange="atualizarSimulador()"
                        style="width: 100%; padding: 0.6rem; background: var(--cinza); border: 1px solid var(--cinza); 
                               border-radius: 6px; color: var(--texto);">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 0.3rem; color: var(--texto-fraco); font-size: 0.85rem;">
                        ‚ûï‚ûñ + Acertar Diferen√ßa de Gols
                    </label>
                    <input type="number" name="pts_diferenca_gols" id="pts-diferenca" value="1" min="0" required
                        onchange="atualizarSimulador()"
                        style="width: 100%; padding: 0.6rem; background: var(--cinza); border: 1px solid var(--cinza); 
                               border-radius: 6px; color: var(--texto);">
                </div>
            </div>
            
            <!-- Checkbox Cr√≠tico -->
            <div style="background: rgba(255, 215, 0, 0.1); padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem; border-left: 3px solid var(--amarelo);">
                <label style="display: flex; align-items: start; gap: 0.8rem; cursor: pointer;">
                    <input type="checkbox" name="requer_resultado" id="requer-resultado" checked
                        onchange="atualizarSimulador()"
                        style="margin-top: 0.3rem; width: 20px; height: 20px; cursor: pointer;">
                    <div>
                        <div style="font-weight: 600; margin-bottom: 0.3rem;">‚ö†Ô∏è Acertos parciais s√≥ valem se acertar o resultado</div>
                        <div style="font-size: 0.85rem; color: var(--texto-fraco);">
                            Se <strong>marcado</strong>: Quem erra o resultado ganha 0 pontos, mesmo acertando gols/diferen√ßa.<br>
                            Se <strong>desmarcado</strong>: Pontua mesmo errando o resultado (pode gerar situa√ß√µes estranhas).
                        </div>
                    </div>
                </label>
            </div>
            
            <!-- B√¥nus El√°stico -->
            <div style="border-top: 1px solid var(--cinza); padding-top: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; cursor: pointer;">
                    <input type="checkbox" name="ativar_bonus_gols" id="checkbox-bonus" onchange="toggleBonusGols(); atualizarSimulador();"
                        style="width: 20px; height: 20px; cursor: pointer;">
                    <span style="font-weight: 600;">üî• B√¥nus por Jogos El√°sticos</span>
                </label>
                
                <div id="campos-bonus" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.3rem; color: var(--texto-fraco); font-size: 0.85rem;">
                                M√≠nimo de Gols no Jogo
                            </label>
                            <input type="number" name="limite_gols_bonus" id="limite-bonus" value="4" min="1"
                                onchange="atualizarSimulador()"
                                style="width: 100%; padding: 0.6rem; background: var(--cinza); border: 1px solid var(--cinza); 
                                       border-radius: 6px; color: var(--texto);">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 0.3rem; color: var(--texto-fraco); font-size: 0.85rem;">
                                Pontos por Gol Extra
                            </label>
                            <input type="number" name="pts_por_gol_extra" id="pts-bonus" value="1" min="1"
                                onchange="atualizarSimulador()"
                                style="width: 100%; padding: 0.6rem; background: var(--cinza); border: 1px solid var(--cinza); 
                                       border-radius: 6px; color: var(--texto);">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Simulador em Tempo Real -->
            <div id="simulador" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--cinza);">
                <h4 style="margin-bottom: 1rem; color: var(--verde);">üìä Simula√ß√£o (Jogo termina 3x1):</h4>
                <div id="exemplos-pontuacao" style="font-family: monospace; font-size: 0.9rem; line-height: 1.8;">
                    <!-- Ser√° preenchido pelo JavaScript -->
                </div>
            </div>
        </div>


        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--texto-fraco); font-size: 0.9rem;">TIPO DE ACESSO</label>
            <select name="tipo_acesso"
                style="width: 100%; padding: 0.8rem; background: var(--cinza-medio); border: 1px solid var(--cinza-medio); 
                       border-radius: 6px; color: var(--texto); font-size: 1rem;">
                <option value="publico">P√∫blico (qualquer um pode entrar com o c√≥digo)</option>
                <option value="privado">Privado (voc√™ precisa aprovar cada participante)</option>
            </select>
        </div>

        <div style="background: var(--cinza-medio); padding: 1rem; border-radius: 6px; margin-bottom: 2rem;">
            <div style="color: var(--texto-fraco); font-size: 0.9rem; margin-bottom: 0.5rem;">VALOR</div>
            <div style="font-size: 1.5rem; font-weight: 600; color: var(--amarelo);">R$ 15,00</div>
            <div style="color: var(--texto-fraco); font-size: 0.8rem; margin-top: 0.5rem;">
                Pagamento via Mercado Pago ap√≥s criar o bol√£o
            </div>
        </div>

        <button type="submit" 
            style="width: 100%; padding: 1rem; background: var(--verde); color: #000; border: none; 
                   border-radius: 6px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: opacity 0.2s;"
            onmouseover="this.style.opacity='0.85'" 
            onmouseout="this.style.opacity='1'">
            Criar Bol√£o e Pagar R$ 15,00
        </button>

        <div style="text-align: center; margin-top: 1rem;">
            <a href="/meus_boloes" style="color: var(--texto-fraco); text-decoration: none; font-size: 0.9rem;">Cancelar</a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
function mostrarCampos() {
    const tipo = document.getElementById('tipo-bolao').value;
    
    document.getElementById('campos-campeonato-completo').style.display = 'none';
    document.getElementById('campos-time-campeonato').style.display = 'none';
    document.getElementById('campos-time-ano').style.display = 'none';
    
    document.getElementById('select-competicao').removeAttribute('required');
    document.getElementById('select-time-campeonato').removeAttribute('required');
    document.getElementById('select-time-ano').removeAttribute('required');
    
    if (tipo === 'campeonato_completo') {
        document.getElementById('campos-campeonato-completo').style.display = 'block';
        document.getElementById('select-competicao').setAttribute('required', 'required');
    } else if (tipo === 'time_campeonato') {
        document.getElementById('campos-time-campeonato').style.display = 'block';
        document.getElementById('select-competicao-time').setAttribute('required', 'required');
        document.getElementById('select-time-campeonato').setAttribute('required', 'required');
    } else if (tipo === 'time_ano_completo') {
        document.getElementById('campos-time-ano').style.display = 'block';
        document.getElementById('select-time-ano').setAttribute('required', 'required');
    }
}

function carregarTimesCampeonato() {
    const competicaoId = document.getElementById('select-competicao-time').value;
    const selectTime = document.getElementById('select-time-campeonato');
    
    if (!competicaoId) {
        selectTime.innerHTML = '<option value="">Escolha a competi√ß√£o primeiro</option>';
        return;
    }
    
    fetch(`/api/times_por_competicao/${competicaoId}`)
        .then(res => res.json())
        .then(data => {
            selectTime.innerHTML = '<option value="">Selecione um time</option>';
            data.times.forEach(time => {
                selectTime.innerHTML += `<option value="${time.id}">${time.nome}</option>`;
            });
        });
}

function toggleBonusGols() {
    const checkbox = document.getElementById('checkbox-bonus');
    const campos = document.getElementById('campos-bonus');
    campos.style.display = checkbox.checked ? 'block' : 'none';

}

function atualizarCamposPontuacao() {
    const modo = document.querySelector('input[name="modo_pontuacao"]:checked').value;
    
    document.getElementById('campos-modo-a').style.display = 'none';
    document.getElementById('campos-modo-b').style.display = 'none';
    document.getElementById('campos-modo-c').style.display = 'none';
    
    if (modo === 'placar_exato') {
        document.getElementById('campos-modo-a').style.display = 'block';
    } else if (modo === 'acertos_parciais') {
        document.getElementById('campos-modo-b').style.display = 'block';
    } else if (modo === 'com_bonus') {
        document.getElementById('campos-modo-c').style.display = 'block';
    }
}
function toggleBonusGols() {
    const checkbox = document.getElementById('checkbox-bonus');
    const campos = document.getElementById('campos-bonus');
    campos.style.display = checkbox.checked ? 'block' : 'none';
}

function atualizarSimulador() {
    const ptsResultado = parseInt(document.getElementById('pts-resultado').value) || 0;
    const ptsGolsVenc = parseInt(document.getElementById('pts-gols-vencedor').value) || 0;
    const ptsGolsPerd = parseInt(document.getElementById('pts-gols-perdedor').value) || 0;
    const ptsDiferenca = parseInt(document.getElementById('pts-diferenca').value) || 0;
    const requerResultado = document.getElementById('requer-resultado').checked;
    const bonusAtivo = document.getElementById('checkbox-bonus').checked;
    const limiteBonus = parseInt(document.getElementById('limite-bonus')?.value) || 4;
    const ptsBonus = parseInt(document.getElementById('pts-bonus')?.value) || 1;
    
    // Jogo exemplo: 3x1 (4 gols totais)
    const exemplos = [
        
        {palpite: '3x1', resultado: true, golsVenc: true, golsPerd: true, diferenca: true},   // Tudo certo
        {palpite: '2x1', resultado: true, golsVenc: false, golsPerd: true, diferenca: false}, // S√≥ resultado e gols perd
        {palpite: '3x0', resultado: true, golsVenc: true, golsPerd: false, diferenca: false}, // S√≥ resultado e gols venc
        {palpite: '2x0', resultado: true, golsVenc: false, golsPerd: false, diferenca: false}, // S√≥ resultado
        {palpite: '4x2', resultado: true, golsVenc: false, golsPerd: false, diferenca: true}, // S√≥ resultado e diferen√ßa
        {palpite: '1x3', resultado: false, golsVenc: false, golsPerd: false, diferenca: false}, // Errou tudo
    ];

    
    let html = '';
    
    exemplos.forEach(ex => {
        let pts = 0;
        let detalhes = [];
        
        if (ex.resultado) {
            pts += ptsResultado;
            detalhes.push(`resultado=${ptsResultado}`);
            
            if (ex.golsVenc) {
                pts += ptsGolsVenc;
                detalhes.push(`gols venc=${ptsGolsVenc}`);
            }
            if (ex.golsPerd) {
                pts += ptsGolsPerd;
                detalhes.push(`gols perd=${ptsGolsPerd}`);
            }
            if (ex.diferenca) {
                pts += ptsDiferenca;
                detalhes.push(`diferen√ßa=${ptsDiferenca}`);
            }
        } else {
            // Errou resultado
            if (requerResultado) {
                pts = 0;
                detalhes.push('errou resultado = 0');
            } else {
                if (ex.golsVenc) {
                    pts += ptsGolsVenc;
                    detalhes.push(`gols venc=${ptsGolsVenc}`);
                }
                if (ex.golsPerd) {
                    pts += ptsGolsPerd;
                    detalhes.push(`gols perd=${ptsGolsPerd}`);
                }
                if (ex.diferenca) {
                    pts += ptsDiferenca;
                    detalhes.push(`diferen√ßa=${ptsDiferenca}`);
                }
            }
        }
        
        // B√¥nus el√°stico (s√≥ se acertou placar exato no exemplo 3x1)
        if (bonusAtivo && ex.palpite === '3x1' && 4 > limiteBonus) {
            const golsExtras = 4 - limiteBonus;
            const bonusPts = golsExtras * ptsBonus;
            pts += bonusPts;
            detalhes.push(`b√¥nus=${bonusPts}`);
        }
        
        const cor = pts >= ptsResultado + ptsGolsVenc + ptsGolsPerd + ptsDiferenca ? 'var(--verde)' : 
                    pts >= ptsResultado ? 'var(--amarelo)' : '#e74c3c';
        
        html += `<div>Palpite <strong>${ex.palpite}</strong> ‚Üí <span style="color: ${cor}; font-weight: 600;">${pts} pts</span> <span style="color: var(--texto-fraco); font-size: 0.85rem;">(${detalhes.join(' + ')})</span></div>`;
    });
    
    document.getElementById('exemplos-pontuacao').innerHTML = html;
}

// Atualiza simulador ao carregar p√°gina
document.addEventListener('DOMContentLoaded', atualizarSimulador);
</script>
<style>
@media (max-width: 768px) {
    h1 {
        font-size: 1.5rem !important;
    }
    
    /* Form responsivo */
    form > div {
        margin-bottom: 1rem !important;
    }
    
    label {
        font-size: 0.85rem !important;
    }
    
    input, select, textarea {
        font-size: 1rem !important;
        padding: 0.7rem !important;
    }
    
    /* Grid de pontua√ß√£o em mobile */
    div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
        gap: 1rem !important;
    }
    
    /* Bot√£o submit */
    button[type="submit"] {
        padding: 1rem !important;
        font-size: 1rem !important;
    }
    
    /* Cards de configura√ß√£o */
    div[style*="background: var(--cinza-medio)"] {
        padding: 1rem !important;
    }
}
</style>
{% endblock %}